(function(n,t,i,r){n.Class.AreasViewModel=function(){var u;return u=this,u.rootUrl=i("meta[name=cards-baseurl]").attr("content"),u.newArea=r.observable(""),u.areas=r.observableArray([]),u.resize=function(){var u,n,r;r=i(t).width(),u=i("#areas article").length,n=(i("#areas article").outerWidth()+12)*u,r<n?i("body").width(n):i("body").width(r)},u.colorizeCard=function(n,t){var r,u;r=i(n),u=r.data("stale"),u>t&&r.addClass("card-aged")},u.colorizeLabel=function(n){var r,t;t=i(n),r=t.data("color"),t.css("background-color",r)},u.colorize=function(){var e,o,s,f,t,r,h,c;for(f=i("#labels span"),t=0,h=f.length;t<h;t++)s=f[t],u.colorizeLabel(s);for(e=i("#cards").data("aged"),n=i("#cards li"),r=0,c=n.length;r<c;r++)o=n[r],u.colorizeCard(o,e)},u.initControls=function(){u.resize(),i().dragScroll();i("#areas").on("dragover","article",function(n){n.preventDefault()}).on("drop","article",function(n){var f,e,t,r,o,s;n.preventDefault(),s=parseInt(n.originalEvent.dataTransfer.getData("AreaID")),o=n.originalEvent.dataTransfer.getData("CardID"),r=i("*[data-cardid="+o+"]"),f=i(n.target).closest("#areas article"),e=i(f).data("areaid"),s!==e&&(t={},t.ID=o,t.AreaID=e,t.Name=i(r).find("a").text(),i.ajax({url:u.rootUrl+"api/cards/"+t.ID,type:"PUT",data:t}).done(function(){var n;n=f.find("#cards"),r.removeClass("card-aged"),n.append(r)}).fail(function(){u.showError("Santa can't figured out what happened, can you try it again?")}))}).on("dragstart","article",function(n){var t,r;t=i(n.target).closest("#areas article").data("areaid"),r=i(n.target).closest("li").data("cardid"),n.originalEvent.dataTransfer.setData("AreaID",t),n.originalEvent.dataTransfer.setData("CardID",r)}).on("click","article footer a",function(n){var t;n.preventDefault(),t=i(this).parent().find("div"),t.is(":visible")||(t.fadeToggle(),t.find("textarea").focus())}).on("keypress","textarea",function(n){return n.which===13?!1:!0}).on("keyup","textarea",function(n){n.which===13&&(n.preventDefault(),i(this).closest("#areas article").find("button").click())}).on("focusout","textarea",function(){i(this).closest("article").find("div").fadeOut()});i("#new-area input[type=text]").on("keyup",function(n){n.preventDefault(),n.which===13&&i("#new-area button").click()});i(t).resize(function(){u.resize()}),i("#error-modal").live("click",function(){i(this).fadeOut()});i("body").on({ajaxStart:function(){i("#error-modal").hide(),i(this).addClass("loading")},ajaxStop:function(){i(this).removeClass("loading")}})},u.refresh=function(){i.getJSON(u.rootUrl+"api/areas").done(function(n){u.areas(n),u.resize(),u.colorize()}).fail(function(){u.showError("Santa can't figured out what happened, can you try it again?")})},u.showError=function(n){i("#error-modal").show(),i("#error-modal span").text(n)},u.addCard=function(){var t,n,r;t=this.ID,r=i("*[data-areaid="+t+"]").find("textarea").val(),n={},n.AreaID=t,n.Name=r,i.post(u.rootUrl+"api/cards",n).done(function(){u.refresh()}).fail(function(){u.showError("Santa can't figured out what happened, can you try it again?")})},u.addArea=function(){var n;n={},n.Name=u.newArea(),i.post(u.rootUrl+"api/areas",n).done(function(){u.refresh()}).fail(function(){u.showError("Santa can't figured out what happened, can you try it again?")}),i("#new-area").fadeToggle(),u.newArea("")},u.showArea=function(){i("#new-area").fadeToggle(),i("#new-area input[type=text]").focus()},u.onReady=function(){r.applyBindings(u),u.initControls(),u.refresh()},u},n.createObject("AreasViewModel")})(window.cards,window,jQuery,ko)